<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomis-AI</title>
    <meta name="theme-color" content="#1A1A1D"/>
    <link rel="manifest" href="manifest.json">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- 全体設定とデザインシステム --- */
        :root {
            --bg-color: #1A1A1D;
            --card-bg-color: rgba(45, 45, 52, 0.7);
            --text-color: #F5F5F5;
            --text-muted-color: #A9A9A9;
            --accent-pink: #E02E97;
            --accent-purple: #7A42F4;
            --border-color: rgba(255, 255, 255, 0.1);
            --font-family: 'Noto Sans JP', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(122, 66, 244, 0.2) 0%, transparent 40%),
                              radial-gradient(circle at 80% 90%, rgba(224, 46, 151, 0.2) 0%, transparent 40%);
            background-attachment: fixed;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* --- ヘッダーとステップインジケーター --- */
        .app-header {
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            list-style: none;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--border-color);
            transform: translateY(-50%);
            z-index: -1;
        }

        .step {
            font-size: 12px;
            color: var(--text-muted-color);
            text-align: center;
            width: 33.33%;
            transition: color 0.3s ease;
        }
        
        .step.active {
            color: var(--text-color);
            font-weight: 700;
        }

        .step.active .step-icon {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            color: white;
            border-color: transparent;
        }

        .step-icon {
            display: block;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            margin: 0 auto 8px;
            line-height: 20px;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
        }

        /* --- 画面制御 --- */
        .screen {
            display: none;
            animation: fadeIn 0.7s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes card-pop-in {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- 汎用コンポーネント --- */
        .main-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
            font-weight: 700;
        }

        h1 {
            font-size: 3rem;
            text-align: center;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .app-logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
        }

        .catch-copy {
            text-align: center;
            color: var(--text-color);
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .app-description {
            text-align: center;
            color: var(--text-muted-color);
            margin-bottom: 40px;
            font-size: 0.9rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            text-decoration: none;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(224, 46, 151, 0.4);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent-pink);
            color: var(--accent-pink);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--accent-pink);
            color: white;
            box-shadow: 0 4px 20px rgba(224, 46, 151, 0.4);
        }
        
        .btn-share {
            background: #1DA1F2;
        }
        .btn-share:hover:not(:disabled) {
            box-shadow: 0 4px 20px rgba(29, 161, 242, 0.4);
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-muted-color);
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }
        
        .back-btn:hover {
            color: var(--text-color);
        }

        /* --- フォーム要素 --- */
        .form-group {
            margin-bottom: 24px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
        }

        .add-btn, .remove-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .add-btn:hover, .remove-btn:hover {
            background-color: var(--accent-pink);
            border-color: var(--accent-pink);
        }
        
        /* オートコンプリート */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2D2D34;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 4px;
        }
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
        }
        .suggestion-item:hover, .suggestion-item.active {
            background-color: var(--accent-purple);
        }

        /* 予算スライダー */
        .budget-slider-container {
            position: relative;
            padding-top: 20px;
        }
        #budget-output {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-purple);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
        }
        #budget-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--border-color);
            outline: none;
            border-radius: 4px;
            transition: opacity .2s;
        }
        #budget-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid var(--accent-pink);
        }
        #budget-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid var(--accent-pink);
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted-color);
            margin-top: 8px;
        }

        /* 選択ボタン */
        .choice-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .choice-btn {
            flex-grow: 1;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .choice-btn.selected {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            color: white;
            box-shadow: 0 0 15px rgba(224, 46, 151, 0.5);
        }
        .choice-btn .fa-solid {
            margin-right: 8px;
        }

        /* --- 画面2: エリア選択 --- */
        .plan-tabs {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .plan-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: transparent;
            border: none;
            color: var(--text-muted-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: bold;
        }
        .plan-tab.active {
            background-color: var(--accent-pink);
            color: white;
        }
        .plan-tab .fa-star {
            color: #FFD700;
        }

        .area-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            min-height: 250px; /* カードが消えても高さが維持されるように */
        }
        
        .area-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: card-pop-in 0.5s ease-out forwards;
            opacity: 0;
        }

        .area-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: var(--accent-pink);
        }
        
        .area-card.exiting {
            animation: card-pop-out 0.3s ease-in forwards;
        }
        
        @keyframes card-pop-out {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(0.95) translateY(20px); }
        }

        .area-card h3 {
            font-size: 1.5rem;
            color: var(--accent-pink);
            margin-bottom: 15px;
        }

        .travel-times-list {
            list-style: none;
            font-size: 14px;
            color: var(--text-muted-color);
        }

        .manual-select-accordion summary {
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .manual-select-accordion summary:hover {
            background-color: var(--card-bg-color);
        }
        .manual-select-accordion summary .fa-chevron-down {
            transition: transform 0.3s;
        }
        .manual-select-accordion[open] summary .fa-chevron-down {
            transform: rotate(180deg);
        }
        .manual-select-content {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        .manual-select-content select {
            width: 100%;
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
        }
        .manual-select-content select option {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* --- 画面3: お店レコメンド --- */
        .best-choice-card {
            animation: card-pop-in 0.5s ease-out;
            padding: 0;
            overflow: hidden;
            border: 2px solid var(--accent-pink);
            position: relative;
        }
        .best-choice-badge {
            position: absolute;
            top: 20px;
            left: -35px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: white;
            padding: 8px 40px;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-45deg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .restaurant-card-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        .restaurant-card-content {
            padding: 24px;
        }
        .best-choice-card h3 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        .restaurant-catch-copy {
            color: var(--text-muted-color);
            font-size: 1rem;
            margin-bottom: 16px;
        }
        .restaurant-point {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid var(--accent-purple);
        }
        .info-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
        }
        .info-tag {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .booking-links {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        .booking-links a {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .booking-links a:hover {
            transform: scale(1.05);
        }
        .tabelog-btn { background-color: #d1a76c; color: #fff; }
        .hotpepper-btn { background-color: #ff5a00; color: #fff; }

        .runner-ups-title {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 20px;
            color: var(--text-muted-color);
        }
        .runner-ups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .runner-up-card {
            padding: 16px;
            transition: all 0.3s ease;
        }
        .runner-up-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: var(--accent-purple);
        }
        .runner-up-card h4 {
            font-size: 1.2rem;
            color: var(--accent-pink);
        }
        .runner-up-card .restaurant-catch-copy {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        .runner-up-card .info-tags {
            margin-bottom: 0;
        }
        .runner-up-card .info-tag {
            font-size: 12px;
            padding: 4px 10px;
        }


        .restaurant-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        /* --- ローディングスピナー --- */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .loader-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-pink);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        #loader-text {
            color: var(--text-color);
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- レスポンシブ対応 --- */
        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            .catch-copy { font-size: 1.1rem; }
            .main-card { padding: 16px; }
            .restaurant-card-content { padding: 16px; }
            .step { font-size: 10px; }
            .step-icon { width: 20px; height: 20px; line-height: 16px; }
            .restaurant-actions { flex-direction: column; }
            .manual-select-content { flex-direction: column; }
            .choice-btn { font-size: 0.95rem; }
        }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader">
        <div class="loader"></div>
        <p id="loader-text"></p>
    </div>

    <div class="app-container">
        <!-- ステップインジケーター -->
        <header class="app-header">
            <ol class="step-indicator">
                <li class="step active" id="step1-indicator">
                    <span class="step-icon">1</span>条件入力
                </li>
                <li class="step" id="step2-indicator">
                    <span class="step-icon">2</span>エリア選択
                </li>
                <li class="step" id="step3-indicator">
                    <span class="step-icon">3</span>お店決定
                </li>
            </ol>
        </header>

        <main>
            <!-- 画面1: タイトル、情報のインプット -->
            <section id="screen1" class="screen active">
                <div class="logo-container">
                    <img src="icons/icon-192x192.png" alt="Nomis-AI Logo" class="app-logo">
                </div>
                <h1>Nomis-AI</h1>
                <p class="catch-copy">飲み会の『最適解』を、一瞬で。</p>
                <p class="app-description">Nomis-AI（ノミサイ）は、面倒な飲み会の店選びを瞬時に解決するアプリです。</p>

                <div class="main-card">
                    <!-- 出発駅入力 -->
                    <div class="form-group">
                        <h3 class="section-title"><i class="fa-solid fa-train-subway"></i>メンバーの出発駅を入力</h3>
                        <div id="station-inputs">
                            <div class="input-group">
                                <input type="text" class="input-field station-input" placeholder="例: 新宿" required>
                            </div>
                        </div>
                        <button class="add-btn" id="add-station-btn"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <!-- 予算入力 -->
                    <div class="form-group">
                        <h3 class="section-title"><i class="fa-solid fa-yen-sign"></i>予算を選択</h3>
                        <div class="budget-slider-container">
                            <div id="budget-output">4000円</div>
                            <input type="range" min="0" max="7" value="2" class="budget-slider" id="budget-slider">
                        </div>
                         <div class="slider-labels">
                            <span>2000円</span>
                            <span>上限なし</span>
                        </div>
                    </div>

                    <!-- シチュエーション -->
                    <div class="form-group">
                        <h3 class="section-title"><i class="fa-solid fa-user-group"></i>シチュエーション (任意)</h3>
                        <div class="choice-buttons" id="situation-btns">
                            <button class="choice-btn" data-value="ひとり"><i class="fa-solid fa-user"></i>ひとりで</button>
                            <button class="choice-btn" data-value="デート"><i class="fa-solid fa-heart"></i>デート</button>
                            <button class="choice-btn" data-value="友達(ワイワイ)"><i class="fa-solid fa-champagne-glasses"></i>友達(ワイワイ)</button>
                            <button class="choice-btn" data-value="友達(語りたい)"><i class="fa-solid fa-comments"></i>友達(語りたい)</button>
                            <button class="choice-btn" data-value="会食"><i class="fa-solid fa-handshake"></i>会食</button>
                        </div>
                    </div>

                    <!-- ジャンル -->
                    <div class="form-group">
                        <h3 class="section-title"><i class="fa-solid fa-utensils"></i>ジャンル (任意)</h3>
                        <div class="choice-buttons" id="genre-btns">
                            <button class="choice-btn" data-value="和食">和食</button>
                            <button class="choice-btn" data-value="洋食">洋食</button>
                            <button class="choice-btn" data-value="中華">中華</button>
                            <button class="choice-btn" data-value="バー">バー</button>
                            <button class="choice-btn" data-value="その他">その他</button>
                        </div>
                    </div>
                </div>
                
                <button id="search-btn" class="btn" style="width: 100%;" disabled>最適解を探す</button>
            </section>

            <!-- 画面2: 飲みエリアの選定 -->
            <section id="screen2" class="screen">
                <button class="back-btn" id="back-to-screen1"><i class="fa-solid fa-chevron-left"></i>条件を選び直す</button>
                <h2 style="text-align: center; margin-bottom: 20px;">どんなエリアを探しますか？</h2>

                <div class="plan-tabs">
                    <button class="plan-tab active" id="fair-plan-btn" data-plan="fair">
                        <i class="fa-solid fa-star"></i> 移動時間公平プラン
                    </button>
                    <button class="plan-tab" id="shortest-plan-btn" data-plan="shortest">
                        <i class="fa-solid fa-stopwatch"></i> 合計時間最短プラン
                    </button>
                </div>
                
                <div id="area-results" class="area-results">
                    <!-- 提案カードがここに挿入される -->
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <button id="research-areas-btn" class="btn btn-secondary">他のエリアを探す</button>
                </div>

                <details class="manual-select-accordion main-card">
                    <summary>
                        自分で飲みエリアを選ぶ
                        <i class="fa-solid fa-chevron-down"></i>
                    </summary>
                    <div class="manual-select-content">
                        <select id="prefecture-select">
                            <option value="">都道府県を選択</option>
                            <option value="東京都">東京都</option>
                            <option value="神奈川県">神奈川県</option>
                            <option value="埼玉県">埼玉県</option>
                            <option value="千葉県">千葉県</option>
                        </select>
                        <select id="area-select" disabled>
                            <option value="">エリアを選択</option>
                        </select>
                    </div>
                </details>
            </section>

            <!-- 画面3: おすすめのお店のレコメンド -->
            <section id="screen3" class="screen">
                <button class="back-btn" id="back-to-screen2"><i class="fa-solid fa-chevron-left"></i>エリアを選び直す</button>
                <h2 id="restaurant-area-title" style="text-align: center;"></h2>
                
                <div id="restaurant-results-container">
                    <!-- お店カードがここに挿入される -->
                </div>

                <div id="no-restaurant-found" style="display: none;" class="main-card text-center">
                    <p>条件に合うお店が見つかりませんでした。<br>AIがうまくお店を見つけられなかったようです。条件やエリアを変えて再検索してみてください。</p>
                </div>
                
                <div class="restaurant-actions">
                    <button id="research-restaurants-btn" class="btn">別の候補をAIに探してもらう</button>
                    <button id="share-btn" class="btn btn-share" style="display: none;"><i class="fa-solid fa-share-nodes"></i> 最適解のお店を共有</button>
                    <button id="google-search-btn" class="btn btn-secondary">Googleでもっと探す</button>
                </div>
            </section>
        </main>
    </div>

    <script>
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

    // --- データ定義 ---
    const station_list = ["新宿", "渋谷", "池袋", "横浜", "東京", "品川", "高田馬場", "北千住", "大手町", "川崎", "大宮", "町田", "有楽町", "新橋", "西船橋", "上野", "船橋", "柏", "吉祥寺", "藤沢", "目黒", "武蔵小杉", "浦和", "中野", "赤羽", "立川", "錦糸町", "日暮里", "恵比寿", "秋葉原", "三鷹", "新木場", "下北沢", "大崎", "五反田", "上大岡", "蒲田", "関内", "戸塚", "高円寺", "松戸", "川口", "海老名", "大井町", "川越", "西日暮里", "押上", "飯田橋", "市川", "津田沼", "中目黒", "国分寺", "代々木上原", "和光市", "浜松町", "登戸", "南越谷", "新越谷", "豊洲", "綾瀬", "日吉", "荻窪", "溝の口", "自由が丘", "大和", "調布", "西武新宿", "田町", "本八幡", "巣鴨", "千葉", "神田", "御茶ノ水", "水道橋", "二子玉川", "八王子", "中延", "志木", "練馬", "茅ケ崎", "四ツ谷", "武蔵溝ノ口", "門前仲町", "鶴見", "新百合ケ丘", "大船", "南浦和", "西国分寺", "朝霞台", "菊名", "日本橋", "所沢", "川越市", "青葉台", "あざみ野", "清澄白河", "新松戸", "春日部", "馬喰横山", "東日本橋", "馬喰町", "駒込", "武蔵浦和", "東神奈川", "田園調布", "桜木町", "京急川崎", "新横浜", "赤坂見附", "永田町", "越谷", "市ケ谷", "中野坂上", "石神井公園", "新浦安", "成増", "明治神宮前", "原宿", "武蔵境", "東陽町", "三軒茶屋", "金町", "大森", "高幡不動", "銀座", "小竹向原", "大泉学園", "府中", "草加", "南船橋", "平塚", "西葛西", "新川崎", "鶴瀬", "上尾", "鷺沼", "小岩", "ひばりケ丘", "武蔵小金井", "たまプラーザ", "相模大野", "本厚木", "小田原", "新小岩", "東武動物公園", "久喜", "川口元郷", "王子", "東中野", "亀戸", "小手指", "保谷", "入間市", "ふじみ野", "霞ケ関", "上福岡", "成田空港", "空港第２ビル", "京成船橋", "京成津田沼", "八千代台", "勝田台", "実籾", "佐倉", "成田", "千葉ニュータウン中央", "印西牧の原", "白井", "小室", "西白井", "千葉中央", "京成千葉", "みどり台", "検見川", "稲毛", "都賀", "四街道", "蘇我", "誉田", "土気", "大網", "茂原", "上総一ノ宮", "木更津", "君津", "五井", "八幡宿", "姉ケ崎", "袖ケ浦", "長浦", "羽田空港第１・第２ターミナル", "羽田空港第３ターミナル", "天空橋", "穴守稲荷", "大鳥居", "糀谷", "京急蒲田", "青物横丁", "鮫洲", "立会川", "平和島", "大森町", "梅屋敷", "雑色", "六郷土手", "金沢八景", "金沢文庫", "能見台", "杉田", "屏風浦", "井土ケ谷", "弘明寺", "日ノ出町", "戸部", "神奈川", "子安", "生麦", "鶴見市場", "八丁畷", "横須賀中央", "汐入", "逸見", "安針塚", "京急田浦", "追浜", "三浦海岸", "三崎口", "逗子・葉山", "新逗子", "神武寺", "六浦", "センター北", "センター南", "中山", "鴨居", "十日市場", "長津田", "つくし野", "すずかけ台", "南町田グランベリーパーク", "つきみ野", "中央林間", "湘南台", "六会日大前", "善行", "藤沢本町", "本鵠沼", "鵠沼海岸", "片瀬江ノ島", "大倉山", "綱島", "日吉本町", "高田", "東山田", "北山田", "元住吉", "新丸子", "多摩川", "沼部", "鵜の木", "下丸子", "武蔵新田", "矢口渡", "蓮沼", "雪が谷大塚", "石川台", "洗足池", "長原", "旗の台", "荏原中延", "戸越銀座", "大崎広小路", "不動前", "祐天寺", "学芸大学", "都立大学", "奥沢", "九品仏", "尾山台", "等々力", "上野毛", "二子新地", "高津", "梶が谷", "宮崎台", "宮前平", "江田", "市が尾", "藤が丘", "西太子堂", "若林", "松陰神社前", "世田谷", "上町", "宮の坂", "山下", "松原", "下高井戸", "桜上水", "上北沢", "八幡山", "芦花公園", "千歳烏山", "仙川", "つつじケ丘", "柴崎", "国領", "布田", "西調布", "飛田給", "武蔵野台", "多磨霊園", "東府中", "府中競馬正門前", "分倍河原", "中河原", "聖蹟桜ケ丘", "百草園", "南平", "平山城址公園", "長沼", "北野", "京王八王子", "山田", "めじろ台", "狭間", "高尾", "高尾山口", "京王多摩センター", "京王永山", "若葉台", "稲城", "京王よみうりランド", "京王稲田堤", "橋本", "南大沢", "多摩境", "堀之内", "井の頭公園", "三鷹台", "久我山", "富士見ケ丘", "高井戸", "浜田山", "西永福", "永福町", "明大前", "東松原", "新代田", "東北沢", "参宮橋", "南新宿", "代々木八幡", "豪徳寺", "経堂", "千歳船橋", "祖師ケ谷大蔵", "成城学園前", "喜多見", "狛江", "和泉多摩川", "向ケ丘遊園", "生田", "読売ランド前", "百合ケ丘", "柿生", "鶴川", "玉川学園前", "相模原", "矢部", "淵野辺", "古淵", "上溝", "番田", "原当麻", "下溝", "相武台下", "入谷", "座間", "かしわ台", "さがみ野", "相模大塚", "瀬谷", "三ツ境", "希望ケ丘", "二俣川", "鶴ケ峰", "西谷", "上星川", "和田町", "星川", "天王町", "平沼橋", "高島町", "みなとみらい", "馬車道", "日本大通り", "元町・中華街", "新高島", "反町", "東白楽", "白楽", "妙蓮寺", "浦和美園", "東川口", "戸塚安行", "新井宿", "鳩ケ谷", "南鳩ケ谷", "赤羽岩淵", "王子神谷", "志茂", "東大島", "大島", "西大島", "住吉", "菊川", "森下", "浜町", "岩本町", "小川町", "神保町", "九段下", "曙橋", "新宿三丁目", "西新宿五丁目", "中井", "落合南長崎", "新江古田", "練馬春日町", "光が丘", "豊島園", "桜台", "江古田", "東長崎", "椎名町", "中村橋", "富士見台", "練馬高野台", "東久留米", "清瀬", "秋津", "西所沢", "狭山ケ丘", "武蔵藤沢", "稲荷山公園", "仏子", "元加治", "飯能", "東飯能", "高麗", "武蔵横手", "東吾野", "吾野", "西吾野", "正丸", "芦ケ久保", "横瀬", "西武秩父", "下山口", "西武球場前", "遊園地西", "西武園", "東村山", "久米川", "小平", "花小金井", "田無", "西武柳沢", "東伏見", "武蔵関", "上石神井", "上井草", "井荻", "下井草", "鷺ノ宮", "都立家政", "野方", "沼袋", "新井薬師前", "下落合", "恋ケ窪", "鷹の台", "八坂", "武蔵大和", "多摩湖", "萩山", "拝島", "西武立川", "武蔵砂川", "玉川上水", "東大和市", "一橋学園", "新小平", "新秋津", "航空公園", "新所沢", "入曽", "狭山市", "新狭山", "南大塚", "本川越", "新河岸", "柳瀬川", "みずほ台", "朝霞", "北朝霞", "下赤塚", "平和台", "氷川台", "千川", "要町", "東池袋", "護国寺", "江戸川橋", "麹町", "桜田門", "銀座一丁目", "新富町", "月島", "辰巳", "竹ノ塚", "西新井", "梅島", "五反野", "小菅", "堀切", "牛田", "鐘ケ淵", "東向島", "曳舟", "とうきょうスカイツリー", "浅草", "谷塚", "獨協大学前", "新田", "蒲生", "北越谷", "大袋", "せんげん台", "武里", "一ノ割", "北春日部", "姫宮", "和戸", "鷲宮", "花崎", "加須", "南羽生", "羽生", "川俣", "茂林寺前", "館林", "野田市", "運河", "江戸川台", "初石", "流山おおたかの森", "豊四季", "新柏", "増尾", "逆井", "高柳", "六実", "新鎌ケ谷", "鎌ケ谷", "馬込沢", "塚田", "新船橋", "大和田", "七里", "岩槻", "東岩槻", "豊春", "八木崎", "藤の牛島", "南桜井", "川間", "清水公園", "愛宕", "北大宮", "大宮公園", "坂戸", "北坂戸", "高坂", "東松山", "森林公園", "つきのわ", "武蔵嵐山", "男衾", "鉢形", "玉淀", "寄居", "大山", "中板橋", "ときわ台", "上板橋", "東武練馬", "西高島平", "新高島平", "高島平", "蓮根", "志村三丁目", "志村坂上", "本蓮沼", "板橋本町", "板橋区役所前", "新板橋", "西巣鴨", "千石", "白山", "三田", "高輪台", "戸越", "馬込", "西馬込", "浅草橋", "蔵前", "新御徒町", "仲御徒町", "上野広小路", "末広町", "淡路町", "新御茶ノ水", "竹橋", "二重橋前", "日比谷", "霞ケ関", "国会議事堂前", "溜池山王", "虎ノ門ヒルズ", "神谷町", "六本木一丁目", "麻布十番", "白金高輪", "白金台", "泉岳寺", "高輪ゲートウェイ", "天王洲アイル", "品川シーサイド", "大井競馬場前", "流通センター", "昭和島", "整備場", "国際線ビル", "新整備場"];

    const DRINKING_AREAS = {
        "東京都": ["新宿", "渋谷", "池袋", "新橋・有楽町", "恵比寿", "上野・御徒町", "赤羽", "吉祥寺", "中野", "高円寺", "下北沢"],
        "神奈川県": ["横浜・野毛", "横浜・関内", "川崎", "武蔵小杉"],
        "埼玉県": ["大宮", "浦和", "川越"],
        "千葉県": ["船橋", "柏"]
    };
    const ALL_DRINKING_AREAS = Object.values(DRINKING_AREAS).flat();

    document.addEventListener('DOMContentLoaded', () => {
        // --- 変数と状態管理 ---
        let travel_times = {}; // JSONからデータを読み込むためのプレースホルダー

        // 外部JSONファイルから移動時間データを非同期で読み込む
        const loadTravelData = async () => {
            try {
                const response = await fetch('travel_times.json'); // travel_times.jsonをフェッチ
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                travel_times = await response.json();
                console.log("travel_times.jsonの読み込みに成功しました。");
            } catch (error) {
                console.error("travel_times.jsonの読み込みに失敗しました:", error);
                // エラーメッセージを表示し、検索ボタンを無効化してアプリの誤動作を防ぐ
                alert("移動時間データの読み込みに失敗しました。ページを再読み込みしてください。");
                searchBtn.disabled = true;
            }
        };
        loadTravelData(); // アプリケーション初期化時にデータ読み込みを開始

        let searchConditions = {
            stations: [],
            budget: 4000,
            situation: null,
            genre: null,
        };
        let currentPlan = 'fair'; // 'fair' or 'shortest'
        let areaResults = [];
        let currentAreaResultPage = 0;
        let selectedArea = null;
        let recommendedRestaurants = [];
        const PLACEHOLDER_IMAGE_URL = 'https://images.unsplash.com/photo-1578662996442-48f60103fc54?q=80&w=800&auto=format&fit=crop';
        const budgetValues = [2000, 3000, 4000, 5000, 6000, 7000, 8000, Infinity];


        // --- DOM要素の取得 ---
        const screens = document.querySelectorAll('.screen');
        const steps = document.querySelectorAll('.step');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');

        // Screen 1
        const stationInputsContainer = document.getElementById('station-inputs');
        const addStationBtn = document.getElementById('add-station-btn');
        const budgetSlider = document.getElementById('budget-slider');
        const budgetOutput = document.getElementById('budget-output');
        const situationBtns = document.getElementById('situation-btns');
        const genreBtns = document.getElementById('genre-btns');
        const searchBtn = document.getElementById('search-btn');

        // Screen 2
        const backToScreen1Btn = document.getElementById('back-to-screen1');
        const fairPlanBtn = document.getElementById('fair-plan-btn');
        const shortestPlanBtn = document.getElementById('shortest-plan-btn');
        const areaResultsContainer = document.getElementById('area-results');
        const researchAreasBtn = document.getElementById('research-areas-btn');
        const prefectureSelect = document.getElementById('prefecture-select');
        const areaSelect = document.getElementById('area-select');

        // Screen 3
        const backToScreen2Btn = document.getElementById('back-to-screen2');
        const restaurantAreaTitle = document.getElementById('restaurant-area-title');
        const restaurantResultsContainer = document.getElementById('restaurant-results-container');
        const noRestaurantFoundMsg = document.getElementById('no-restaurant-found');
        const researchRestaurantsBtn = document.getElementById('research-restaurants-btn');
        const googleSearchBtn = document.getElementById('google-search-btn');
        const shareBtn = document.getElementById('share-btn');

        // --- 汎用関数 ---
        const showLoader = (show, message = '') => {
            loader.classList.toggle('visible', show);
            loaderText.textContent = message;
        };

        const showScreen = (screenId) => {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            steps.forEach(step => step.classList.remove('active'));
            if (screenId === 'screen1') document.getElementById('step1-indicator').classList.add('active');
            if (screenId === 'screen2') {
                document.getElementById('step1-indicator').classList.add('active');
                document.getElementById('step2-indicator').classList.add('active');
            }
            if (screenId === 'screen3') {
                document.getElementById('step1-indicator').classList.add('active');
                document.getElementById('step2-indicator').classList.add('active');
                document.getElementById('step3-indicator').classList.add('active');
            }
            window.scrollTo(0, 0);
        };

        const validateForm = () => {
            const stations = Array.from(document.querySelectorAll('.station-input'))
                                .map(input => input.value.trim())
                                .filter(station => station !== '' && station_list.includes(station));
            searchBtn.disabled = stations.length === 0;
        };

        // --- 画面1: 条件入力のロジック ---
        
        // 駅入力の動的追加・削除
        const createStationInput = () => {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-field station-input';
            input.placeholder = `メンバー${stationInputsContainer.children.length + 1}の駅`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fa-solid fa-minus"></i>';
            removeBtn.onclick = () => {
                inputGroup.remove();
                updateInputPlaceholders();
                validateForm();
            };

            inputGroup.appendChild(input);
            inputGroup.appendChild(removeBtn);
            stationInputsContainer.appendChild(inputGroup);
            addAutocomplete(input);
            validateForm();
        };
        
        addStationBtn.addEventListener('click', createStationInput);

        const updateInputPlaceholders = () => {
            const inputs = stationInputsContainer.querySelectorAll('.station-input');
            inputs.forEach((input, index) => {
                input.placeholder = `メンバー${index + 1}の駅`;
            });
        };

        // オートコンプリート機能
        const addAutocomplete = (input) => {
            let currentFocus;
            input.addEventListener('input', function(e) {
                const val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;
                const suggestions = document.createElement('div');
                suggestions.setAttribute('class', 'autocomplete-suggestions');
                this.parentNode.appendChild(suggestions);

                const filteredStations = station_list.filter(s => s.toUpperCase().includes(val.toUpperCase()));
                filteredStations.slice(0, 5).forEach(station => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `<strong>${station.substr(0, val.length)}</strong>${station.substr(val.length)}`;
                    item.addEventListener('click', function(e) {
                        input.value = station;
                        closeAllLists();
                        validateForm();
                    });
                    suggestions.appendChild(item);
                });
            });

            input.addEventListener('keydown', function(e) {
                let x = this.parentNode.querySelector('.autocomplete-suggestions');
                if (x) x = x.getElementsByTagName('div');
                if (e.keyCode == 40) { // down
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // up
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add('active');
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove('active');
                }
            }
        };
        
        const closeAllLists = (elmnt) => {
            const items = document.getElementsByClassName('autocomplete-suggestions');
            for (let i = 0; i < items.length; i++) {
                if (elmnt != items[i] && elmnt != items[i].parentNode.querySelector('.station-input')) {
                    items[i].parentNode.removeChild(items[i]);
                }
            }
        };

        document.addEventListener('click', (e) => closeAllLists(e.target));
        
        addAutocomplete(document.querySelector('.station-input'));
        stationInputsContainer.addEventListener('input', validateForm);

        // 予算スライダー
        const updateBudgetSlider = () => {
            const value = parseInt(budgetSlider.value);
            const budget = budgetValues[value];
            searchConditions.budget = budget;
            
            const percent = (value / (budgetSlider.max - budgetSlider.min)) * 100;
            budgetSlider.style.background = `linear-gradient(to right, var(--accent-pink) ${percent}%, var(--border-color) ${percent}%)`;

            if (budget === Infinity) {
                budgetOutput.textContent = '上限なし';
            } else {
                budgetOutput.textContent = `${budget}円`;
            }
            budgetOutput.style.left = `calc(${percent}% + (${12 - percent * 0.24}px))`;
        };
        budgetSlider.addEventListener('input', updateBudgetSlider);
        updateBudgetSlider();

        // 選択ボタン（シチュエーション、ジャンル）
        const setupChoiceButtons = (container, conditionKey) => {
            container.addEventListener('click', (e) => {
                const button = e.target.closest('.choice-btn');
                if (!button) return;

                const currentValue = button.dataset.value;
                const selectedBtn = container.querySelector('.choice-btn.selected');
                
                if (selectedBtn && selectedBtn === button) {
                    button.classList.remove('selected');
                    searchConditions[conditionKey] = null;
                } else {
                    if(selectedBtn) selectedBtn.classList.remove('selected');
                    button.classList.add('selected');
                    searchConditions[conditionKey] = currentValue;
                }
            });
        };
        setupChoiceButtons(situationBtns, 'situation');
        setupChoiceButtons(genreBtns, 'genre');

        // 検索ボタン
        searchBtn.addEventListener('click', () => {
            const stations = Array.from(document.querySelectorAll('.station-input'))
                                .map(input => input.value.trim())
                                .filter(station => station !== '' && station_list.includes(station));
            
            if (stations.length === 0) {
                alert('有効な駅名を1つ以上入力してください。');
                return;
            }
            searchConditions.stations = [...new Set(stations)]; // 重複を削除
            
            showLoader(true, '最適なエリアを計算中...');
            setTimeout(() => {
                calculateAndDisplayAreas();
                showScreen('screen2');
                showLoader(false);
            }, 500);
        });

        // --- 画面2: エリア選択のロジック ---
        const calculateAndDisplayAreas = () => {
            areaResults = calculateAreaScores();
            currentAreaResultPage = 0;
            displayAreaResults();
        };
        
        const calculateAreaScores = () => {
            const scores = ALL_DRINKING_AREAS.map(area => {
                const times = searchConditions.stations.map(station => travel_times[station]?.[area] ?? 999);
                
                const sum = times.reduce((a, b) => a + b, 0);
                const mean = sum / times.length;
                const stdDev = Math.sqrt(times.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / times.length);

                return {
                    name: area,
                    fairScore: stdDev,
                    shortestScore: sum,
                    times: times,
                };
            });
            
            if (currentPlan === 'fair') {
                scores.sort((a, b) => a.fairScore - b.fairScore);
            } else {
                scores.sort((a, b) => a.shortestScore - b.shortestScore);
            }
            return scores;
        };

        const displayAreaResults = () => {
            const existingCards = areaResultsContainer.querySelectorAll('.area-card');
            existingCards.forEach(card => card.classList.add('exiting'));

            setTimeout(() => {
                areaResultsContainer.innerHTML = '';
                const start = currentAreaResultPage * 3;
                const end = start + 3;
                const pageResults = areaResults.slice(start, end);

                if (pageResults.length === 0) {
                    areaResultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted-color);">これ以上候補はありません。</p>';
                    researchAreasBtn.disabled = true;
                    return;
                }
                
                researchAreasBtn.disabled = areaResults.length <= end;

                pageResults.forEach((result, i) => {
                    const card = document.createElement('div');
                    card.className = 'area-card';
                    card.style.animationDelay = `${i * 0.1}s`;
                    card.dataset.areaName = result.name;

                    const timesList = searchConditions.stations.map((station, index) => 
                        `<li>${station}から <strong>${result.times[index]}</strong>分</li>`
                    ).join('');

                    card.innerHTML = `
                        <h3>${result.name}</h3>
                        <ul class="travel-times-list">${timesList}</ul>
                    `;
                    card.addEventListener('click', () => selectArea(result.name));
                    areaResultsContainer.appendChild(card);
                });
            }, 300);
        };

        fairPlanBtn.addEventListener('click', () => switchPlan('fair'));
        shortestPlanBtn.addEventListener('click', () => switchPlan('shortest'));

        const switchPlan = (plan) => {
            if (currentPlan === plan) return;
            currentPlan = plan;
            fairPlanBtn.classList.toggle('active', plan === 'fair');
            shortestPlanBtn.classList.toggle('active', plan === 'shortest');
            calculateAndDisplayAreas();
        };

        researchAreasBtn.addEventListener('click', () => {
            currentAreaResultPage++;
            displayAreaResults();
        });

        backToScreen1Btn.addEventListener('click', () => showScreen('screen1'));
        
        prefectureSelect.addEventListener('change', () => {
            const pref = prefectureSelect.value;
            areaSelect.innerHTML = '<option value="">エリアを選択</option>';
            areaSelect.disabled = true;
            if (pref && DRINKING_AREAS[pref]) {
                DRINKING_AREAS[pref].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                areaSelect.disabled = false;
            }
        });
        
        areaSelect.addEventListener('change', () => {
            const area = areaSelect.value;
            if (area) {
                selectArea(area);
            }
        });

        // --- 画面3: AIによるお店レコメンド ---
        const selectArea = (areaName) => {
            selectedArea = areaName;
            restaurantAreaTitle.innerHTML = `<span style="color: var(--accent-pink);">${selectedArea}</span> の最適解`;
            showScreen('screen3');
            findAndDisplayRestaurants();
        };

        researchRestaurantsBtn.addEventListener('click', findAndDisplayRestaurants);

        async function getAiRecommendations(area, budget, situation, genre) {
            const apiUrl = '/.netlify/functions/get-recommendations'; // Google API URLをNetlify Functionのエンドポイントに変更

            const situationText = situation ? `シチュエーションは「${situation}」` : '';
            const genreText = genre ? `ジャンルは「${genre}」` : '';
            const budgetUpper = budget;
            const budgetLower = (budget === 2000) ? 0 : budgetValues[budgetValues.indexOf(budget) - 1];
            const budgetText = budget === Infinity ? '8001円以上' : `1人あたり${budgetLower}円から${budgetUpper}円`;

            const prompt = `
                あなたは首都圏の飲食店に詳しいコンシェルジュです。
                以下の条件に合う最高の飲食店を3軒提案してください。
                - エリア: "${area}"
                - 予算: ${budgetText}
                - ${situationText}
                - ${genreText}

                回答はJSONオブジェクト形式で、"recommendations"というキーを持つ配列を必ず含めてください。配列には3つの店舗オブジェクトを入れてください。
                配列の最初のオブジェクトが、あなたの最もおすすめする「最適解」です。
                各店舗オブジェクトには、以下の情報を必ず含めてください。
                - "name": 店名 (string)
                - "catch_copy": 魅力的なキャッチコピー (string)
                - "recommend_point": おすすめポイントの説明 (string)
                - "budget_min": 予算下限 (number)
                - "budget_max": 予算上限 (number)
                - "tags": { "smoking": "禁煙/分煙/喫煙可" (string), "options": ["個室あり"など] (array of strings) } を含むオブジェクト
                - "image_url": お店の雰囲気や料理がわかる、実在する綺麗な写真のURL (string)。見つからなければ空文字。
                - "google_map_url": そのお店のGoogle Map検索URL (string)
            `;

            const payload = {
              contents: [{ parts: [{ text: prompt }] }],
              generationConfig: { responseMimeType: "application/json" },
            };

            try {
                // API呼び出しに指数バックオフを追加
                let response;
                let attempts = 0;
                const maxAttempts = 5;
                let delay = 1000;

                while (attempts < maxAttempts) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // 成功
                        } else if (response.status === 429 || response.status >= 500) {
                            // リトライ対象のエラー
                            console.log(`Attempt ${attempts + 1} failed, retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            attempts++;
                        } else {
                           throw new Error(`API call failed with status: ${response.status}`);
                        }
                    } catch (networkError) {
                        console.log(`Attempt ${attempts + 1} failed with network error, retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        attempts++;
                         if(attempts >= maxAttempts) throw networkError;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`API call failed after ${maxAttempts} attempts.`);
                }

                const result = await response.json();
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error("Invalid response structure from AI.");
                }
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                return parsedJson.recommendations;
            } catch (error) {
                console.error("AI recommendation error:", error);
                return null;
            }
        }
        
        async function findAndDisplayRestaurants() {
            showLoader(true, 'AIが最適なお店を解析中...');
            restaurantResultsContainer.innerHTML = '';
            noRestaurantFoundMsg.style.display = 'none';

            try {
                recommendedRestaurants = await getAiRecommendations(selectedArea, searchConditions.budget, searchConditions.situation, searchConditions.genre);
                displayRestaurantResults();
            } catch (error) {
                console.error("AI recommendation failed:", error);
                recommendedRestaurants = []; // エラー時は空にする
                displayRestaurantResults(); // エラーメッセージを表示させる
            } finally {
                showLoader(false); // 成功・失敗に関わらずローダーを必ず非表示にする
            }
        };

        const displayRestaurantResults = () => {
            restaurantResultsContainer.innerHTML = '';
            
            if (!recommendedRestaurants || recommendedRestaurants.length === 0) {
                restaurantResultsContainer.style.display = 'none';
                noRestaurantFoundMsg.style.display = 'block';
                shareBtn.style.display = 'none';
                return;
            }
            
            restaurantResultsContainer.style.display = 'block';
            noRestaurantFoundMsg.style.display = 'none';
            
            // 最適解（最初の1軒）
            const bestChoice = recommendedRestaurants[0];
            if (bestChoice) {
                restaurantResultsContainer.appendChild(createBestChoiceCard(bestChoice));
                if (navigator.share && bestChoice.google_map_url) {
                    shareBtn.style.display = 'block';
                    shareBtn.onclick = () => {
                        navigator.share({
                            title: `このお店どう？「${bestChoice.name}」`,
                            text: `Nomis-AIが見つけた最適解のお店！\n${bestChoice.catch_copy}`,
                            url: bestChoice.google_map_url,
                        }).catch(e => console.log("Share failed:", e));
                    };
                } else {
                    shareBtn.style.display = 'none';
                }
            }

            // 次点候補
            const runnerUps = recommendedRestaurants.slice(1);
            if (runnerUps.length > 0) {
                const runnerUpsTitle = document.createElement('h3');
                runnerUpsTitle.className = 'runner-ups-title';
                runnerUpsTitle.textContent = 'こちらもおすすめです';
                restaurantResultsContainer.appendChild(runnerUpsTitle);

                const runnerUpsContainer = document.createElement('div');
                runnerUpsContainer.className = 'runner-ups-container';
                runnerUps.forEach(r => runnerUpsContainer.appendChild(createRunnerUpCard(r)));
                restaurantResultsContainer.appendChild(runnerUpsContainer);
            }
        };

        const createBestChoiceCard = (restaurant) => {
            const card = document.createElement('div');
            card.className = 'main-card best-choice-card';
            const imageUrl = restaurant.image_url || PLACEHOLDER_IMAGE_URL;
            const tagsHtml = `
                <div class="info-tag"><i class="fa-solid fa-yen-sign"></i> 予算: ¥${restaurant.budget_min}～¥${restaurant.budget_max}</div>
                ${restaurant.tags?.smoking ? `<div class="info-tag"><i class="fa-solid fa-smoking"></i> ${restaurant.tags.smoking}</div>` : ''}
                ${restaurant.tags?.options?.map(opt => `<div class="info-tag"><i class="fa-solid fa-check"></i> ${opt}</div>`).join('') || ''}
            `;
            card.innerHTML = `
                <div class="best-choice-badge">最適解 ✨</div>
                <img src="${imageUrl}" alt="${restaurant.name}" class="restaurant-card-image" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE_URL}';">
                <div class="restaurant-card-content">
                    <h3>${restaurant.name || '店舗名不明'}</h3>
                    <p class="restaurant-catch-copy">${restaurant.catch_copy || ''}</p>
                    <div class="restaurant-point">
                        <strong>おすすめポイント:</strong> ${restaurant.recommend_point || '詳細情報なし'}
                    </div>
                    <div class="info-tags">${tagsHtml}</div>
                    <div class="booking-links">
                        <a href="#" target="_blank" class="tabelog-btn">食べログで予約</a>
                        <a href="#" target="_blank" class="hotpepper-btn">ホットペッパーで予約</a>
                    </div>
                </div>
            `;
            return card;
        };

        const createRunnerUpCard = (restaurant) => {
            const card = document.createElement('div');
            card.className = 'main-card runner-up-card';
            const tagsHtml = `
                <div class="info-tag"><i class="fa-solid fa-yen-sign"></i> ¥${restaurant.budget_min || '?'}～</div>
                ${searchConditions.genre ? `<div class="info-tag"><i class="fa-solid fa-tag"></i> ${searchConditions.genre}</div>` : ''}
            `;
            card.innerHTML = `
                <h4>${restaurant.name || '店舗名不明'}</h4>
                <p class="restaurant-catch-copy">${restaurant.catch_copy || ''}</p>
                <div class="info-tags">${tagsHtml}</div>
            `;
            return card;
        };
        
        googleSearchBtn.addEventListener('click', () => {
            const query = encodeURIComponent(`${selectedArea} 居酒屋`);
            window.open(`https://www.google.com/search?q=${query}`, '_blank');
        });

        backToScreen2Btn.addEventListener('click', () => showScreen('screen2'));

        // --- 初期化 ---
        validateForm();
    });
    </script>
</body>
</html>


